<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - LeasePilot AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-[#F3F5F7] text-slate-900 antialiased selection:bg-slate-200">

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="hidden md:flex w-72 flex-col justify-between border-r border-slate-200 bg-white p-6">
            <div>
                <a href="index.html" class="flex items-center mb-10">
                    <img src="https://ik.imagekit.io/primo/Primo%20Motif/leasepilot-logo.svg" alt="LeasePilot AI" class="h-12">
                </a>

                <nav class="space-y-1">
                    <a href="index.html" class="flex items-center gap-3 rounded-full px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors">
                        <i data-lucide="layout-grid" class="h-5 w-5"></i>
                        Dashboard
                    </a>
                    <a href="properties.html" class="flex items-center gap-3 rounded-full px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors">
                        <i data-lucide="home" class="h-5 w-5"></i>
                        Properties
                    </a>
                    <a href="tenants.html" class="flex items-center gap-3 rounded-full px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors">
                        <i data-lucide="users" class="h-5 w-5"></i>
                        Tenants
                    </a>
                    <a href="maintenance.html" class="flex items-center gap-3 rounded-full px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors">
                        <i data-lucide="wrench" class="h-5 w-5"></i>
                        Maintenance
                    </a>
                    <a href="contractors.html" class="flex items-center gap-3 rounded-full px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors">
                        <i data-lucide="hard-hat" class="h-5 w-5"></i>
                        Contractors
                    </a>
                    <a href="messages.html" class="flex items-center gap-3 rounded-full px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors">
                        <i data-lucide="message-square" class="h-5 w-5"></i>
                        Messages
                    </a>
                    <a href="financials.html" class="flex items-center gap-3 rounded-full px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors">
                        <i data-lucide="wallet" class="h-5 w-5"></i>
                        Financials
                    </a>
                    <a href="settings.html" class="flex items-center gap-3 rounded-full bg-slate-100 px-4 py-3 text-sm font-medium text-slate-900 transition-colors">
                        <i data-lucide="settings" class="h-5 w-5 text-slate-900"></i>
                        Settings
                    </a>
                </nav>
            </div>

            <div>
                <div class="mb-6 rounded-3xl bg-[#EBC7B6] p-5 relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="mb-2 text-lg font-medium tracking-tight text-slate-900">Upgrade to Pro</p>
                        <p class="mb-4 text-sm text-slate-700">Unlock advanced AI forecasting for your portfolio.</p>
                        <button class="rounded-full bg-slate-900 px-4 py-2 text-xs font-medium text-white transition-transform hover:scale-105">
                            View Plans
                        </button>
                    </div>
                    <div class="absolute -right-4 -top-4 h-24 w-24 rounded-full bg-white/20"></div>
                </div>

                <div class="flex items-center gap-3 border-t border-slate-100 pt-5">
                    <img data-user-avatar src="https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?auto=format&fit=crop&q=80&w=100&h=100" alt="User" class="h-10 w-10 rounded-full object-cover ring-2 ring-white">
                    <div class="flex flex-col flex-1">
                        <span class="text-sm font-medium" data-user-name>Sarah Jenkins</span>
                        <span class="text-xs text-slate-500">Portfolio Manager</span>
                    </div>
                    <button onclick="LeasePilot.logout()" class="text-slate-400 hover:text-slate-600" title="Logout">
                        <i data-lucide="log-out" class="h-4 w-4"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto hide-scrollbar">
            <div class="flex md:hidden items-center justify-between bg-white p-4 border-b border-slate-100">
                <div class="flex items-center gap-2">
                    <a href="index.html" class="flex items-center">
                        <img src="https://ik.imagekit.io/primo/Primo%20Motif/leasepilot-logo.svg" alt="LeasePilot AI" class="h-10">
                    </a>
                </div>
                <button class="text-slate-500"><i data-lucide="menu" class="h-6 w-6"></i></button>
            </div>

            <div class="mx-auto max-w-4xl px-6 py-8 md:px-10 md:py-12">
                
                <div class="mb-8">
                    <h1 class="text-3xl font-medium tracking-tight text-slate-900">Settings</h1>
                    <p class="mt-2 text-sm text-slate-500">Manage your account and preferences.</p>
                </div>

                <!-- Profile Settings -->
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-6 mb-6">
                    <h2 class="text-lg font-semibold text-slate-900 mb-6">Profile</h2>
                    <div class="space-y-5">
                        <div class="flex items-center gap-4">
                            <img id="profilePhoto" src="https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?auto=format&fit=crop&q=80&w=100&h=100" alt="Profile" class="h-16 w-16 rounded-full object-cover ring-2 ring-slate-100">
                            <input type="file" id="avatarInput" accept="image/jpeg,image/png,image/gif,image/webp" class="hidden">
                            <div>
                                <button type="button" id="changePhotoBtn" class="inline-flex items-center gap-2 rounded-xl border-2 border-slate-300 bg-white px-4 py-2.5 text-sm font-semibold text-slate-800 shadow-sm transition-colors hover:border-slate-900 hover:bg-slate-50 hover:text-slate-900 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-2">
                                    <i data-lucide="camera" class="h-4 w-4"></i>
                                    Change photo
                                </button>
                                <p class="text-xs text-slate-500 mt-2">JPG, PNG, GIF or WebP. Max 2MB.</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Full Name</label>
                                <input type="text" id="userName" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-slate-400 focus:ring-2 focus:ring-slate-100 outline-none" value="Sarah Jenkins">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Email</label>
                                <input type="email" id="userEmail" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-slate-400 focus:ring-2 focus:ring-slate-100 outline-none" value="sarah@example.com">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Role</label>
                            <input type="text" id="userRole" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 bg-slate-50 outline-none cursor-not-allowed" value="Portfolio Manager" disabled>
                        </div>
                        <button type="button" id="saveProfileBtn" onclick="saveProfile()" class="rounded-xl bg-slate-900 px-5 py-2.5 text-sm font-medium text-white hover:bg-slate-800 transition-colors">
                            Save Changes
                        </button>
                    </div>
                </div>

                <!-- Preferences (saved to localStorage) -->
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-6 mb-6">
                    <h2 class="text-lg font-semibold text-slate-900 mb-6">Preferences</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-900">Email Notifications</p>
                                <p class="text-xs text-slate-500">Receive email updates about your properties</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="prefEmailNotifications" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-slate-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-slate-900"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-900">SMS Notifications</p>
                                <p class="text-xs text-slate-500">Get urgent alerts via text message</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="prefSmsNotifications" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-slate-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-slate-900"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-900">AI Insights</p>
                                <p class="text-xs text-slate-500">Enable AI-powered recommendations</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="prefAiInsights" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-slate-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-slate-900"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Billing -->
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-6 mb-6">
                    <h2 class="text-lg font-semibold text-slate-900 mb-6">Billing</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 rounded-xl border border-slate-200">
                            <div>
                                <p class="text-sm font-medium text-slate-900">Current Plan</p>
                                <p class="text-xs text-slate-500">Free Plan</p>
                            </div>
                            <button class="rounded-xl bg-slate-900 px-4 py-2 text-xs font-medium text-white hover:bg-slate-800">
                                Upgrade
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-4 rounded-xl border border-slate-200">
                            <div>
                                <p class="text-sm font-medium text-slate-900">Payment Method</p>
                                <p class="text-xs text-slate-500">No payment method on file</p>
                            </div>
                            <button class="rounded-xl border border-slate-200 px-4 py-2 text-xs font-medium text-slate-700 hover:bg-slate-50">
                                Add Card
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="bg-white rounded-3xl border border-red-200 shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-red-900 mb-6">Danger Zone</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 rounded-xl border border-red-200 bg-red-50">
                            <div>
                                <p class="text-sm font-medium text-red-900">Delete Account</p>
                                <p class="text-xs text-red-700">Permanently delete your account and all data</p>
                            </div>
                            <button onclick="deleteAccount()" class="rounded-xl bg-red-600 px-4 py-2 text-xs font-medium text-white hover:bg-red-700">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
                
                <footer class="mt-12 pt-8 text-center md:text-left border-t border-slate-200">
                    <p class="text-xs text-slate-400">Â© 2024 LeasePilot AI Inc.</p>
                </footer>

            </div>
        </main>
    </div>

    <script>
        lucide.createIcons({ attrs: { 'stroke-width': 1.5 } });

        (async function() {
            var wait = 0;
            while (typeof LeasePilot === 'undefined' && wait < 100) {
                await new Promise(function(r) { setTimeout(r, 50); });
                wait++;
            }
            if (typeof LeasePilot === 'undefined') return;
            await LeasePilot.checkAuth();

            var defaultAvatar = 'https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?auto=format&fit=crop&q=80&w=100&h=100';
            function avatarFullUrl(url) {
                return (url && url.startsWith('/')) ? (window.location.origin || '') + url : (url || defaultAvatar);
            }
            function setProfilePhotoSrc(url) {
                var full = avatarFullUrl(url);
                var el = document.getElementById('profilePhoto');
                if (el) el.src = full;
                document.querySelectorAll('[data-user-avatar]').forEach(function(img) { img.src = full; });
            }

            var dm = LeasePilot.DataManager;
            if (dm && dm.getProfile) {
                try {
                    var user = await dm.getProfile();
                    if (user) {
                        document.getElementById('userName').value = user.name || '';
                        document.getElementById('userEmail').value = user.email || '';
                        var roleEl = document.querySelector('#userRole');
                        if (roleEl) roleEl.value = user.role || 'Portfolio Manager';
                        setProfilePhotoSrc(user.avatar_url);
                    }
                } catch (e) {
                    var fromStorage = LeasePilot.getCurrentUser();
                    if (fromStorage) {
                        document.getElementById('userName').value = fromStorage.name || '';
                        document.getElementById('userEmail').value = fromStorage.email || '';
                    }
                }
            } else {
                var fromStorage = LeasePilot.getCurrentUser();
                if (fromStorage) {
                    document.getElementById('userName').value = fromStorage.name || '';
                    document.getElementById('userEmail').value = fromStorage.email || '';
                    setProfilePhotoSrc(fromStorage.avatar_url);
                }
            }

            var avatarInput = document.getElementById('avatarInput');
            var changePhotoBtn = document.getElementById('changePhotoBtn');
            if (changePhotoBtn && avatarInput) {
                changePhotoBtn.addEventListener('click', function() { avatarInput.click(); });
                avatarInput.addEventListener('change', async function() {
                    var file = this.files && this.files[0];
                    if (!file) return;
                    if (file.size > 2 * 1024 * 1024) {
                        if (LeasePilot.Toast) LeasePilot.Toast.show('Image must be 2MB or smaller.', 'error');
                        return;
                    }
                    var uploadFn = (LeasePilot.DataManager && LeasePilot.DataManager.uploadAvatar) ? LeasePilot.DataManager.uploadAvatar.bind(LeasePilot.DataManager) : null;
                    if (!uploadFn) {
                        if (LeasePilot.Toast) LeasePilot.Toast.show('Upload not available. Refresh the page.', 'error');
                        return;
                    }
                    changePhotoBtn.disabled = true;
                    try {
                        var updated = await uploadFn(file);
                        if (updated && updated.avatar_url) {
                            setProfilePhotoSrc(updated.avatar_url);
                            localStorage.setItem('user', JSON.stringify(updated));
                            if (LeasePilot.Toast) LeasePilot.Toast.show('Photo updated.', 'success');
                        } else {
                            if (LeasePilot.Toast) LeasePilot.Toast.show('Upload succeeded but no photo URL returned.', 'error');
                        }
                    } catch (err) {
                        var msg = (err && err.message) ? err.message : 'Failed to upload photo.';
                        if (LeasePilot.Toast) LeasePilot.Toast.show(msg, 'error');
                        console.error('Avatar upload error:', err);
                    } finally {
                        changePhotoBtn.disabled = false;
                        avatarInput.value = '';
                    }
                });
            }

            // Preferences: load from localStorage and save on change
            var PREFS_KEY = 'leasepilot_preferences';
            var defaultPrefs = { emailNotifications: true, smsNotifications: false, aiInsights: true };
            function loadPreferences() {
                try {
                    var s = localStorage.getItem(PREFS_KEY);
                    var p = s ? JSON.parse(s) : defaultPrefs;
                    var emailEl = document.getElementById('prefEmailNotifications');
                    var smsEl = document.getElementById('prefSmsNotifications');
                    var aiEl = document.getElementById('prefAiInsights');
                    if (emailEl) emailEl.checked = !!p.emailNotifications;
                    if (smsEl) smsEl.checked = !!p.smsNotifications;
                    if (aiEl) aiEl.checked = !!p.aiInsights;
                } catch (e) {}
            }
            function savePreferences() {
                var emailEl = document.getElementById('prefEmailNotifications');
                var smsEl = document.getElementById('prefSmsNotifications');
                var aiEl = document.getElementById('prefAiInsights');
                var p = {
                    emailNotifications: emailEl ? emailEl.checked : true,
                    smsNotifications: smsEl ? smsEl.checked : false,
                    aiInsights: aiEl ? aiEl.checked : true
                };
                try {
                    localStorage.setItem(PREFS_KEY, JSON.stringify(p));
                } catch (e) {}
            }
            loadPreferences();
            ['prefEmailNotifications', 'prefSmsNotifications', 'prefAiInsights'].forEach(function(id) {
                var el = document.getElementById(id);
                if (el) el.addEventListener('change', savePreferences);
            });
        })();

        window.saveProfile = async function() {
            if (typeof LeasePilot === 'undefined') {
                alert('App not loaded. Refresh the page and try again.');
                return;
            }
            var nameEl = document.getElementById('userName');
            var emailEl = document.getElementById('userEmail');
            var name = (nameEl && nameEl.value) ? nameEl.value.trim() : '';
            var email = (emailEl && emailEl.value) ? emailEl.value.trim() : '';
            if (!name) {
                if (LeasePilot.Toast) LeasePilot.Toast.show('Name is required.', 'error');
                return;
            }
            if (!email) {
                if (LeasePilot.Toast) LeasePilot.Toast.show('Email is required.', 'error');
                return;
            }
            var btn = document.getElementById('saveProfileBtn');
            if (btn) btn.disabled = true;
            try {
                var updated = await LeasePilot.API.put('/users/me', { name: name, email: email });
                if (updated && (updated.name !== undefined || updated.email !== undefined)) {
                    localStorage.setItem('user', JSON.stringify(updated));
                    document.querySelectorAll('[data-user-name]').forEach(function(el) { el.textContent = updated.name || ''; });
                    if (LeasePilot.Toast) LeasePilot.Toast.show('Profile saved.', 'success');
                } else {
                    if (LeasePilot.Toast) LeasePilot.Toast.show('Unexpected response. Please try again.', 'error');
                }
            } catch (e) {
                var msg = (e && e.message) ? e.message : 'Failed to save profile.';
                if (LeasePilot.Toast) LeasePilot.Toast.show(msg, 'error');
                console.error('Save profile error:', e);
            } finally {
                if (btn) btn.disabled = false;
            }
        };

        window.deleteAccount = async function() {
            if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) return;
            try {
                await LeasePilot.DataManager.deleteAccount();
            } catch (e) {}
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        };
    </script>

</body>
</html>

