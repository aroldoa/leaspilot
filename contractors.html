<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contractors - LeasePilot AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>body { font-family: 'Inter', sans-serif; } .hide-scrollbar::-webkit-scrollbar { display: none; } .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }</style>
</head>
<body class="bg-[#F3F5F7] text-slate-900 antialiased">
  <div class="flex h-screen overflow-hidden">
    <aside class="hidden md:flex w-72 flex-col justify-between border-r border-slate-200 bg-white p-6">
      <div>
        <a href="index.html" class="flex items-center mb-10">
          <img src="https://ik.imagekit.io/primo/Primo%20Motif/leasepilot-logo.svg" alt="LeasePilot AI" class="h-12">
        </a>
        <nav class="space-y-1">
          <a href="index.html" class="flex items-center gap-3 rounded-full px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors">
            <i data-lucide="layout-grid" class="h-5 w-5"></i> Dashboard
          </a>
          <a href="properties.html" class="flex items-center gap-3 rounded-full px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors">
            <i data-lucide="home" class="h-5 w-5"></i> Properties
          </a>
          <a href="tenants.html" class="flex items-center gap-3 rounded-full px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors">
            <i data-lucide="users" class="h-5 w-5"></i> Tenants
          </a>
          <a href="maintenance.html" class="flex items-center gap-3 rounded-full px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors">
            <i data-lucide="wrench" class="h-5 w-5"></i> Maintenance
          </a>
          <a href="contractors.html" class="flex items-center gap-3 rounded-full bg-slate-100 px-4 py-3 text-sm font-medium text-slate-900 transition-colors">
            <i data-lucide="hard-hat" class="h-5 w-5 text-slate-900"></i> Contractors
          </a>
          <a href="messages.html" class="flex items-center gap-3 rounded-full px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors">
            <i data-lucide="message-square" class="h-5 w-5"></i> Messages
          </a>
          <a href="financials.html" class="flex items-center gap-3 rounded-full px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors">
            <i data-lucide="wallet" class="h-5 w-5"></i> Financials
          </a>
          <a href="settings.html" class="flex items-center gap-3 rounded-full px-4 py-3 text-sm font-medium text-slate-500 hover:bg-slate-50 transition-colors">
            <i data-lucide="settings" class="h-5 w-5"></i> Settings
          </a>
        </nav>
      </div>
      <div class="flex items-center gap-3 border-t border-slate-100 pt-5">
        <a href="settings.html" class="flex items-center gap-3 flex-1 hover:opacity-80">
          <img src="https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?auto=format&fit=crop&q=80&w=100&h=100" alt="User" class="h-10 w-10 rounded-full object-cover ring-2 ring-white">
          <div class="flex flex-col flex-1">
            <span class="text-sm font-medium" data-user-name>Sarah Jenkins</span>
            <span class="text-xs text-slate-500">Portfolio Manager</span>
          </div>
        </a>
        <button onclick="LeasePilot.logout()" class="text-slate-400 hover:text-slate-600" title="Logout"><i data-lucide="log-out" class="h-4 w-4"></i></button>
      </div>
    </aside>
    <main class="flex-1 overflow-y-auto hide-scrollbar">
      <div class="mx-auto max-w-7xl px-6 py-8 md:px-10 md:py-12">
        <div class="flex flex-wrap items-center justify-between gap-4">
          <div>
            <h1 class="text-3xl font-medium tracking-tight text-slate-900">Contractors</h1>
            <p class="mt-2 text-sm text-slate-500">Manage vendors you assign to maintenance requests.</p>
          </div>
          <button type="button" id="addContractorBtn" class="rounded-full bg-slate-900 px-4 py-2.5 text-sm font-medium text-white hover:bg-slate-800 inline-flex items-center gap-2">
            <i data-lucide="plus" class="h-4 w-4"></i> Add contractor
          </button>
        </div>
        <div class="mt-8 rounded-2xl border border-slate-100 bg-white shadow-sm overflow-hidden">
          <div id="contractorsList" class="divide-y divide-slate-100">
            <p class="text-slate-400 text-sm py-8 px-6">Loading...</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add/Edit contractor modal -->
  <div id="contractorModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/40" aria-hidden="true">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6" onclick="event.stopPropagation()">
      <h3 class="text-lg font-semibold text-slate-900" id="contractorModalTitle">Add contractor</h3>
      <input type="hidden" id="contractorId" value="">
      <div class="mt-4 space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Name *</label>
          <input type="text" id="contractorName" required class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-slate-900 placeholder-slate-400 focus:border-slate-400 focus:outline-none" placeholder="John Smith">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Company</label>
          <input type="text" id="contractorCompany" class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-slate-900 placeholder-slate-400 focus:border-slate-400 focus:outline-none" placeholder="ABC Plumbing">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Phone</label>
          <input type="tel" id="contractorPhone" class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-slate-900 placeholder-slate-400 focus:border-slate-400 focus:outline-none" placeholder="(555) 123-4567">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
          <input type="email" id="contractorEmail" class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-slate-900 placeholder-slate-400 focus:border-slate-400 focus:outline-none" placeholder="john@example.com">
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Specialty</label>
          <select id="contractorSpecialty" class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-slate-900 focus:border-slate-400 focus:outline-none">
            <option value="">Any</option>
            <option value="plumbing">Plumbing</option>
            <option value="electrical">Electrical</option>
            <option value="hvac">HVAC</option>
            <option value="appliance">Appliance</option>
            <option value="pest">Pest control</option>
            <option value="general">General</option>
          </select>
        </div>
      </div>
      <div class="mt-6 flex gap-3 justify-end">
        <button type="button" onclick="closeContractorModal()" class="rounded-full px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100">Cancel</button>
        <button type="button" id="contractorModalSubmit" class="rounded-full bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800">Save</button>
      </div>
    </div>
  </div>

  <!-- Send SMS modal -->
  <div id="smsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/40" aria-hidden="true">
    <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6" onclick="event.stopPropagation()">
      <h3 class="text-lg font-semibold text-slate-900">Send SMS</h3>
      <p class="text-sm text-slate-500 mt-1" id="smsModalRecipient">To: …</p>
      <input type="hidden" id="smsModalContractorId" value="">
      <input type="hidden" id="smsModalTenantId" value="">
      <div class="mt-4">
        <label class="block text-sm font-medium text-slate-700 mb-1">Message</label>
        <textarea id="smsModalBody" rows="3" class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-slate-900 placeholder-slate-400 focus:border-slate-400 focus:outline-none" placeholder="Type your message..."></textarea>
        <p class="mt-1.5 text-xs text-slate-400">Twilio trial: you can only send to numbers verified in your <a href="https://twilio.com/user/account/phone-numbers/verified" target="_blank" rel="noopener" class="text-slate-600 hover:underline">Twilio console</a>.</p>
      </div>
      <div class="mt-6 flex gap-3 justify-end">
        <button type="button" onclick="closeSmsModal()" class="rounded-full px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100">Cancel</button>
        <button type="button" id="smsModalSend" class="rounded-full bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800">Send</button>
      </div>
    </div>
  </div>

  <script>
    (async function() {
      var w = 0;
      while (typeof LeasePilot === 'undefined' && w < 100) { await new Promise(function(r) { setTimeout(r, 50); }); w++; }
      if (typeof LeasePilot === 'undefined') return;
      await LeasePilot.checkAuth();
      lucide.createIcons();

      function esc(s) {
        if (s == null) return '';
        var d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
      }

      var smsConfigured = false;

      function loadContractors() {
        var el = document.getElementById('contractorsList');
        LeasePilot.DataManager.getContractors()
          .then(function(list) {
            if (!list || list.length === 0) {
              el.innerHTML = '<div class="py-12 px-6 text-center text-slate-500"><i data-lucide="hard-hat" class="h-12 w-12 mx-auto mb-4 text-slate-300"></i><p>No contractors yet.</p><p class="text-sm mt-1">Add contractors to assign them to maintenance requests.</p></div>';
            } else {
              el.innerHTML = list.map(function(c) {
                var line = [c.name, c.company].filter(Boolean).join(' · ');
                var sub = [c.phone, c.email, c.specialty].filter(Boolean).join(' · ');
                var smsBtn = (smsConfigured && c.phone) ? '<button type="button" onclick="openSmsModalContractor(' + c.id + ', \'' + esc((c.name || '').replace(/'/g, "\\'")) + '\')" class="rounded-lg p-2 text-slate-400 hover:bg-slate-100 hover:text-slate-700" title="Send SMS"><i data-lucide="message-circle" class="h-4 w-4"></i></button>' : '';
                return '<div class="flex items-center gap-4 px-6 py-4">' +
                  '<div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl bg-slate-100 text-slate-600"><i data-lucide="user" class="h-5 w-5"></i></div>' +
                  '<div class="min-w-0 flex-1">' +
                    '<p class="font-medium text-slate-900">' + esc(line || 'Contractor') + '</p>' +
                    (sub ? '<p class="text-sm text-slate-500 truncate">' + esc(sub) + '</p>' : '') +
                  '</div>' +
                  smsBtn +
                  '<button type="button" onclick="editContractor(' + c.id + ')" class="rounded-lg p-2 text-slate-400 hover:bg-slate-100 hover:text-slate-700" title="Edit"><i data-lucide="pencil" class="h-4 w-4"></i></button>' +
                  '<button type="button" onclick="deleteContractor(' + c.id + ', \'' + esc((c.name || '').replace(/'/g, "\\'")) + '\')" class="rounded-lg p-2 text-slate-400 hover:bg-red-50 hover:text-red-600" title="Delete"><i data-lucide="trash-2" class="h-4 w-4"></i></button>' +
                '</div>';
              }).join('');
            }
            lucide.createIcons();
          })
          .catch(function() {
            el.innerHTML = '<p class="py-8 px-6 text-slate-500 text-sm">Unable to load contractors.</p>';
          });
      }

      window.openSmsModalContractor = function(id, name) {
        document.getElementById('smsModalTenantId').value = '';
        document.getElementById('smsModalContractorId').value = id;
        document.getElementById('smsModalRecipient').textContent = 'To: ' + name;
        document.getElementById('smsModalBody').value = '';
        document.getElementById('smsModal').classList.remove('hidden');
        document.getElementById('smsModal').classList.add('flex');
      };
      window.closeSmsModal = function() {
        document.getElementById('smsModal').classList.add('hidden');
        document.getElementById('smsModal').classList.remove('flex');
      };
      document.getElementById('smsModal').addEventListener('click', function(e) {
        if (e.target === this) closeSmsModal();
      });
      document.getElementById('smsModalSend').onclick = function() {
        var contractorId = document.getElementById('smsModalContractorId').value;
        var tenantId = document.getElementById('smsModalTenantId').value;
        var body = document.getElementById('smsModalBody').value.trim() || 'Hi, this is your property manager. Please reach out when you can.';
        var btn = this;
        btn.disabled = true;
        var promise = contractorId
          ? LeasePilot.DataManager.sendSmsToContractor(contractorId, body)
          : LeasePilot.DataManager.sendSmsToTenant(tenantId, body);
        promise.then(function() {
          closeSmsModal();
          if (window.LeasePilot && window.LeasePilot.Toast) LeasePilot.Toast.show('SMS sent');
        }).catch(function(err) {
          if (window.LeasePilot && window.LeasePilot.Toast) LeasePilot.Toast.show(err.message || 'Failed to send SMS', 'error');
        }).finally(function() { btn.disabled = false; });
      };

      window.closeContractorModal = function() {
        document.getElementById('contractorModal').classList.add('hidden');
        document.getElementById('contractorModal').classList.remove('flex');
      };

      window.openContractorModal = function(contractor) {
        document.getElementById('contractorModalTitle').textContent = contractor ? 'Edit contractor' : 'Add contractor';
        document.getElementById('contractorId').value = contractor ? contractor.id : '';
        document.getElementById('contractorName').value = contractor ? (contractor.name || '') : '';
        document.getElementById('contractorCompany').value = contractor ? (contractor.company || '') : '';
        document.getElementById('contractorPhone').value = contractor ? (contractor.phone || '') : '';
        document.getElementById('contractorEmail').value = contractor ? (contractor.email || '') : '';
        document.getElementById('contractorSpecialty').value = contractor ? (contractor.specialty || '') : '';
        document.getElementById('contractorModal').classList.remove('hidden');
        document.getElementById('contractorModal').classList.add('flex');
      };

      function editContractor(id) {
        LeasePilot.DataManager.getContractors().then(function(list) {
          var c = list.find(function(x) { return x.id === id; });
          if (c) openContractorModal(c);
        });
      }
      window.editContractor = editContractor;

      window.deleteContractor = function(id, name) {
        if (!confirm('Delete contractor "' + name + '"? They will be unassigned from any maintenance requests.')) return;
        LeasePilot.DataManager.deleteContractor(id).then(function() {
          loadContractors();
          if (window.LeasePilot && window.LeasePilot.Toast) LeasePilot.Toast.show('Contractor deleted');
        }).catch(function() {
          if (window.LeasePilot && window.LeasePilot.Toast) LeasePilot.Toast.show('Failed to delete', 'error');
        });
      };

      document.getElementById('addContractorBtn').onclick = function() { openContractorModal(null); };

      document.getElementById('contractorModalSubmit').onclick = function() {
        var id = document.getElementById('contractorId').value;
        var name = document.getElementById('contractorName').value.trim();
        if (!name) {
          if (window.LeasePilot && window.LeasePilot.Toast) LeasePilot.Toast.show('Name is required', 'error');
          return;
        }
        var data = {
          name: name,
          company: document.getElementById('contractorCompany').value.trim() || null,
          phone: document.getElementById('contractorPhone').value.trim() || null,
          email: document.getElementById('contractorEmail').value.trim() || null,
          specialty: document.getElementById('contractorSpecialty').value || null
        };
        var promise = id ? LeasePilot.DataManager.updateContractor(id, data) : LeasePilot.DataManager.createContractor(data);
        promise.then(function() {
          closeContractorModal();
          loadContractors();
          if (window.LeasePilot && window.LeasePilot.Toast) LeasePilot.Toast.show(id ? 'Contractor updated' : 'Contractor added');
        }).catch(function() {
          if (window.LeasePilot && window.LeasePilot.Toast) LeasePilot.Toast.show('Failed to save', 'error');
        });
      };

      document.getElementById('contractorModal').addEventListener('click', function(e) {
        if (e.target === this) closeContractorModal();
      });

      LeasePilot.DataManager.getSmsStatus().then(function(s) {
        smsConfigured = s && s.configured;
        loadContractors();
      }).catch(function() { loadContractors(); });
    })();
  </script>
</body>
</html>
