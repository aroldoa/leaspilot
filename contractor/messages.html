<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages - Contractor Portal | LeasePilot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="../app.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-[#F3F5F7] text-slate-900 antialiased">
  <div class="min-h-screen">
    <header class="bg-white border-b border-slate-200">
      <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
        <a href="messages.html" class="flex items-center gap-2">
          <img src="https://ik.imagekit.io/primo/Primo%20Motif/leasepilot-logo.svg" alt="LeasePilot" class="h-9">
          <span class="font-medium text-slate-700">Contractor Portal</span>
        </a>
        <nav class="flex items-center gap-1">
          <a href="messages.html" class="rounded-full bg-slate-100 px-4 py-2 text-sm font-medium text-slate-900">Messages</a>
          <button onclick="LeasePilot.logout()" class="rounded-full p-2 text-slate-400 hover:text-slate-600" title="Sign out"><i data-lucide="log-out" class="h-4 w-4"></i></button>
        </nav>
      </div>
    </header>
    <main class="max-w-5xl mx-auto px-4 py-8">
      <h1 class="text-2xl font-semibold text-slate-900 mb-6">Messages</h1>
      <p class="text-slate-600 text-sm mb-6">Messages from your property manager. You can reply below each message.</p>
      <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
        <div id="messagesList" class="divide-y divide-slate-100">Loading...</div>
      </div>
    </main>
  </div>
  <script>
    (async function() {
      var wait = 0;
      while (typeof LeasePilot === 'undefined' && wait < 100) { await new Promise(function(r) { setTimeout(r, 50); }); wait++; }
      if (typeof LeasePilot === 'undefined') return;
      await LeasePilot.checkAuth();
      lucide.createIcons();

      var API = window.LeasePilot && window.LeasePilot.API;
      if (!API) { document.getElementById('messagesList').innerHTML = '<p class="p-6 text-slate-400">Unable to load messages.</p>'; return; }

      function esc(s) { return (s || '').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
      function formatDate(d) { return d ? new Date(d).toLocaleString() : ''; }

      async function load() {
        var el = document.getElementById('messagesList');
        try {
          var list = await API.get('/contractor/messages');
          if (!list || !list.length) {
            el.innerHTML = '<p class="p-6 text-slate-500">No messages yet.</p>';
            return;
          }
          var html = '';
          list.forEach(function(thread) {
            var unread = !thread.read_at;
            html += '<div class="p-4 border-b border-slate-100 last:border-0" data-thread-id="' + thread.id + '">';
            html += '<div class="' + (unread ? ' bg-slate-50/50 -m-2 p-2 rounded-lg' : '') + '">';
            html += '<p class="font-medium text-slate-900">' + esc(thread.subject) + '</p>';
            html += '<p class="text-sm text-slate-600 mt-1 whitespace-pre-wrap">' + esc(thread.body) + '</p>';
            html += '<p class="text-xs text-slate-400 mt-2">' + formatDate(thread.created_at) + (unread ? ' <span class="text-amber-600">Unread</span>' : '') + '</p>';
            if (unread) {
              html += '<button type="button" class="message-read-btn mt-2 rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-600 hover:bg-slate-100" data-id="' + thread.id + '">Mark read</button>';
            }
            html += '</div>';
            if (thread.replies && thread.replies.length) {
              html += '<div class="mt-3 ml-3 pl-3 border-l-2 border-slate-200 space-y-2">';
              thread.replies.forEach(function(r) {
                html += '<div class="text-sm">';
                html += '<span class="font-medium text-slate-700">' + (r.from_me ? 'You' : 'Manager') + '</span>';
                html += ' <span class="text-slate-400 text-xs">' + formatDate(r.created_at) + '</span>';
                html += '<p class="text-slate-600 whitespace-pre-wrap mt-0.5">' + esc(r.body) + '</p>';
                html += '</div>';
              });
              html += '</div>';
            }
            html += '<div class="mt-3">';
            html += '<textarea class="reply-body w-full px-3 py-2 rounded-xl border border-slate-200 text-sm focus:ring-2 focus:ring-slate-100 outline-none" rows="2" placeholder="Reply to manager..." data-parent-id="' + thread.id + '"></textarea>';
            html += '<button type="button" class="reply-btn mt-2 rounded-xl bg-slate-900 text-white px-4 py-2 text-sm font-medium hover:bg-slate-800" data-parent-id="' + thread.id + '">Send reply</button>';
            html += '</div>';
            html += '</div>';
          });
          el.innerHTML = html;

          el.querySelectorAll('.message-read-btn').forEach(function(btn) {
            btn.addEventListener('click', async function() {
              var id = btn.getAttribute('data-id');
              if (!id) return;
              try {
                await API.patch('/contractor/messages/' + encodeURIComponent(id) + '/read');
                await load();
              } catch (e) { if (window.LeasePilot.Toast) window.LeasePilot.Toast.show('Could not mark as read.', 'error'); }
            });
          });
          el.querySelectorAll('.reply-btn').forEach(function(btn) {
            btn.addEventListener('click', async function() {
              var parentId = btn.getAttribute('data-parent-id');
              var card = btn.closest('[data-thread-id]');
              var textarea = card ? card.querySelector('.reply-body') : null;
              var body = textarea ? textarea.value.trim() : '';
              if (!body) {
                if (window.LeasePilot.Toast) window.LeasePilot.Toast.show('Please enter a message.', 'error');
                return;
              }
              btn.disabled = true;
              try {
                await API.post('/contractor/messages', { parent_message_id: parentId, body: body });
                if (window.LeasePilot.Toast) window.LeasePilot.Toast.show('Reply sent.', 'success');
                if (textarea) textarea.value = '';
                await load();
              } catch (e) {
                if (window.LeasePilot.Toast) window.LeasePilot.Toast.show(e.message || 'Could not send reply.', 'error');
              } finally {
                btn.disabled = false;
              }
            });
          });
        } catch (e) {
          el.innerHTML = '<p class="p-6 text-slate-400">Unable to load messages.</p>';
        }
      }
      await load();
    })();
  </script>
</body>
</html>
